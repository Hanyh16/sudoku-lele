import { writable } from 'svelte/store';

// 回溯计数（仍保留计数用于显示），但用于判断是否能回溯我们提供布尔 store
const branchBackTimes = writable(0);

// 布尔 stores：用于驱动按钮禁用（用户要求布尔，不要计数驱动）
const canUndo = writable(false);
const canRedo = writable(false);
const canBacktrack = writable(false);

function addBranch(/* timeStep - ignored */) {
  // 增加计数并更新 canBacktrack
  branchBackTimes.update((n) => {
    const next = n + 1;
    try { console.debug('[historyState.addBranch] branchBackTimes ->', next); } catch (e) {}
    canBacktrack.set(next > 0);
    return next;
  });
}

function popBranch() {
  // 减少计数（最小为 0），返回是否成功弹出（true 表示之前有可弹出的分支）
  let popped = false;
  branchBackTimes.update((n) => {
    if (n > 0) {
      popped = true;
      const next = n - 1;
      try { console.debug('[historyState.popBranch] branchBackTimes ->', next); } catch (e) {}
      canBacktrack.set(next > 0);
      return next;
    }
    try { console.debug('[historyState.popBranch] branchBackTimes ->', 0); } catch (e) {}
    canBacktrack.set(false);
    return 0;
  });
  return popped;
}

export const historyState = {
  branchBackTimes,
  canUndo,
  canRedo,
  canBacktrack,
  addBranch,
  popBranch,
};
